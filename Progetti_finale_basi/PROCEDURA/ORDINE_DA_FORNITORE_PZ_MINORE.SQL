-- ORDINE DI UN PRODOTTO INSERITO DA TASTIERA DAL FORNITORE CHE LO VENDE AL PREZZO PIU BASSO.

CREATE OR REPLACE PROCEDURE ORDINE_FORN
(COD_BARRE0 VARCHAR2,CF_DIRETTORE0 VARCHAR2,QUANTITA_LOTTO NUMBER)
IS
PZF NUMBER;
PFORN VARCHAR2(16);
PZLO NUMBER;
NP VARCHAR2(50);
PZV NUMBER;
SOTT VARCHAR2(20);
MAXF NUMBER;
MAXL NUMBER;
NMAG NUMBER;
NWQT NUMBER;
PEZZIDISP NUMBER;
SOMMA_C NUMBER;
SOMMA_V NUMBER;
BEGIN

-- PREZZO PIU BASSO DEL PRODOTTO PIU VENDUTO DAL FORNITORE
SELECT F.CF_FORNITORE, PREZZO_FORNITORE INTO PFORN,PZF
FROM FORNITORE F JOIN VENDUTO V ON (F.CF_FORNITORE=V.CF_FORNITORE)
WHERE COD_BARRE=COD_BARRE0 AND (PREZZO_FORNITORE) =ANY (SELECT MIN(PREZZO_FORNITORE) 
														FROM VENDUTO 
														WHERE COD_BARRE=COD_BARRE0);
-- MAGAZZINO ASSOCIATO A QUEL DIRETTORE										
SELECT NUM_MAG INTO NMAG
FROM SOCIAL_CLUB S JOIN MAGAZZINO M ON S.LOCALITA=M.LOCALITA
WHERE CF_DIRETTORE=CF_DIRETTORE0;

-- COD ULTIMA FORNITURA								
SELECT (MAX(COD_FORNITURA)) INTO MAXF
FROM FORNITURA;

-- COD ULTIMO LOTTO
SELECT (MAX(NUM_LOTTO)) INTO MAXL
FROM LOTTO;


-- QUERY CHE DATO UN PRODOTTO QUALSIASI TROVA QUANTI PEZZI NE HO VENDUTO.
SELECT SUM(QUANTITA_C) INTO SOMMA_V
FROM CONTIENE
WHERE COD_BARRE=COD_BARRE0;
					
-- QUERY CHE DATO UN PRODOTTO QUALSIASI TROVA QUANTI PEZZI NE HO COMPRATO.
SELECT SUM(QUANTITA_LOTTO) INTO SOMMA_C
FROM LOTTO
WHERE COD_BARRE=COD_BARRE0;


-- QUANTITA ATTUALE DEL PRODTTO					
PEZZIDISP:= SOMMA_C-SOMMA_V;
-- PREZZO DEL LOTTO
PZLO:= PZF*QUANTITA_LOTTO;
-- AGGIORNO LA QUANTITA
NWQT:= PEZZIDISP+QUANTITA_LOTTO;
-- AGGIORNO IL NUMERO DELLA NUOVA FORNITURA
MAXF:= NUOVI_COD_FORN.NEXTVAL;

-- ORDINE DEL PRODOTTO DAL FORNITORE CHE VENDE IL PRODOTTO INSERITO AL PREZZO PIU BASSO.  										
INSERT INTO FORNITURA(COD_FORNITURA,DATA_FOR,CF_FORNITORE,NUM_MAG,CF_DIRETTORE) VALUES (MAXF,SYSDATE,PFORN,NMAG,CF_DIRETTORE0);
INSERT INTO LOTTO(NUM_LOTTO,QUANTITA_LOTTO,PREZZO_LOTTO, COD_BARRE, COD_FORNITURA) VALUES (NUOVI_NUM_LOTTO.NEXTVAL,NWQT,PZLO,COD_BARRE0,MAXF);
END ORDINE_FORN;
/
