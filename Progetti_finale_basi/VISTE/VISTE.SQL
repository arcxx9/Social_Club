-- VISTA CHE VISUALIZZA LE INFO DEI CLIENTI D
CREATE VIEW INFO_CL AS
SELECT P.NOME,DATA_FINE AS VAL,P.COGNOME AS COGNOME,PROD.NOME_PRODOTTO AS NOME_PRO,PROD.SOTTOSOTTOTIPO AS TIPO,PROD.PREZZO_VENDITA AS PREZZO,S.DATA_ORA AS DATA_A	
FROM PERSONA P JOIN CLIENTE C ON(P.CF_PERSONA=C.CF_CLIENTE)
JOIN TESSERA T ON(C.CF_CLIENTE=T.CF_CLIENTE)
JOIN SCONTRINO S ON (T.NUM_TESSERA=S.NUM_TESSERA)
JOIN CONTIENE CO ON(S.NUM_SCONTRINO=CO.NUM_SCONTRINO)
JOIN PRODOTTO PROD ON(CO.COD_BARRE=PROD.COD_BARRE);


-- VISTA CHE VISUALIZZA IL PRODOTTO PIU COSTOSO D
CREATE VIEW MAX_PREZZO_PROD AS
	SELECT COD_BARRE,NOME_PRODOTTO,PREZZO_VENDITA AS PREZZO
	FROM PRODOTTO
	WHERE PREZZO_VENDITA=(SELECT MAX(PREZZO_VENDITA) FROM PRODOTTO);
	

-- VISTA PER CALCOLARE L'UTILE DEL SOCIAL CLUB. D
CREATE VIEW UTILE_S AS 
SELECT SC.NOME_SOCIAL_CLUB,STIPENDIO AS STIPENDIO_DIRETTORE, (((SUM(P.PREZZO_VENDITA)-SUM(P.PREZZO_LISTINO)) -STIPENDIO) + SUM(COSTO)) AS UTILE
FROM DIRETTORE D JOIN SOCIAL_CLUB SC ON (D.CF_DIRETTORE=SC.CF_DIRETTORE) 
JOIN SCONTRINO S ON (SC.LOCALITA=S.LOCALITA)
JOIN TESSERA T ON (T.NUM_TESSERA=S.NUM_TESSERA)
JOIN CONTIENE C ON (C.NUM_SCONTRINO=S.NUM_SCONTRINO)
JOIN PRODOTTO P ON (C.COD_BARRE=P.COD_BARRE)
GROUP BY SC.NOME_SOCIAL_CLUB,STIPENDIO;

-- VISTA CLIENTE CHE HA EFFETTUATO PIU ACQUISTI NELL'ULTIMO MESE.D
CREATE VIEW BESTCL AS
SELECT S.NUM_TESSERA
FROM SCONTRINO S 
WHERE TO_CHAR(DATA_ORA,'DD-MM-YYYY')>=TO_CHAR(SYSDATE-60) AND S.NUM_TESSERA IN (SELECT S2.NUM_TESSERA
						FROM  SCONTRINO S2 JOIN CONTIENE C ON (S.NUM_SCONTRINO=C.NUM_SCONTRINO)
						WHERE S2.NUM_TESSERA=S.NUM_TESSERA
						GROUP BY S2.NUM_TESSERA
						HAVING (COUNT(COD_BARRE))=(SELECT MAX(COUNT(COD_BARRE))
														FROM  SCONTRINO S JOIN CONTIENE C ON (S.NUM_SCONTRINO=C.NUM_SCONTRINO)
														GROUP BY S.NUM_TESSERA))
GROUP BY S.NUM_TESSERA;




